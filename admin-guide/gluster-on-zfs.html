<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Gluster User Documentation Latest | Gluster Docs Project | Gluster on ZFS</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <link href="../../latest/_stylesheets/asciibinder.css" rel="stylesheet" />

   <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
   <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
   <!--[if lt IE 9]>
     <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
     <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
   <![endif]-->

  <link href="../../latest/_images/favicon32x32.png" rel="shortcut icon" type="text/css">
  <!--[if IE]><link rel="shortcut icon" href="../../latest/_images/favicon.ico"><![endif]-->
  <meta content="AsciiBinder" name="application-name">
</head>
<body>
  <div class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="http://www.asciibinder.org/"><img alt="AsciiBinder" src="../../latest/_images/asciibinder-logo-horizontal.png"></a>
      </div>
    </div>
  </div>
  <div class="container">
    <p class="toggle-nav visible-xs pull-left">
      <button class="btn btn-default btn-sm" type="button" data-toggle="offcanvas">Toggle nav</button>
    </p>
    <ol class="breadcrumb">
      <li class="sitename">
        <a href="../../index.html">Home</a>
      </li>
      <li class="hidden-xs active">
        <a href="../admin-guide/index.html">Gluster User Documentation Latest</a>
      </li>
      <li class="hidden-xs active">
        <a href="../admin-guide/index.html">Gluster Docs Project</a>
      </li>
      
      <li class="hidden-xs active">
        Gluster on ZFS
      </li>
    </ol>
    <div class="row row-offcanvas row-offcanvas-left">
      <div class="col-xs-8 col-sm-3 col-md-3 sidebar sidebar-offcanvas">
        <ul class="nav nav-sidebar">
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup0">
        <span id="tgSpan0" class="fa fa-angle-down"></span>Gluster Docs Project
      </a>
      <ul id="topicGroup0" class="collapse in list-unstyled">
            <li><a class="" href="../admin-guide/index.html">Index</a></li>
            <li><a class="" href="../admin-guide/access-control-lists.html">Access Control Lists</a></li>
            <li><a class="" href="../admin-guide/accessing-gluster-from-windows.html">Accessing Gluster from Windows</a></li>
            <li><a class="" href="../admin-guide/arbiter-volumes-and-quorum.html">Arbiter-volumes and Quorum</a></li>
            <li><a class="" href="../admin-guide/bareos.html">BareOS</a></li>
            <li><a class="" href="../admin-guide/brick-naming-conventions.html">Brick naming conventions</a></li>
            <li><a class="" href="../admin-guide/building-qemu-with-gfapi-for-debian-based-systems.html">Building QEMU with gfapi for Debian-based systems</a></li>
            <li><a class="" href="../admin-guide/cinder.html">Cinder</a></li>
            <li><a class="" href="../admin-guide/Console.html">Console</a></li>
            <li><a class="" href="../admin-guide/compiling-rpms.html">Compiling RPMs</a></li>
            <li><a class="" href="../admin-guide/coreutils.html">Coreutils</a></li>
            <li><a class="" href="../admin-guide/did-you-know.html">Did you know</a></li>
            <li><a class="" href="../admin-guide/directory-quota.html">Diectory Quota</a></li>
            <li><a class="" href="../admin-guide/distributed-geo-replication.html">Distributed Geo Replication</a></li>
            <li><a class="" href="../admin-guide/export-and-netgroup-authentication.html">Export and netgroup authentication</a></li>
            <li><a class="" href="../admin-guide/filter.html">Filter</a></li>
            <li><a class="" href="../admin-guide/geo-replication.html">Geo Replication</a></li>
            <li><a class="" href="../admin-guide/glossary.html">Glossary</a></li>
            <li><a class=" active" href="../admin-guide/gluster-on-zfs.html">Gluster on ZFS</a></li>
            <li><a class="" href="../admin-guide/Hadoop.html">Hadoop</a></li>
            <li><a class="" href="../admin-guide/Handling-of-users-with-many-groups.html">Handling of users with many groups</a></li>
            <li><a class="" href="../admin-guide/introduction.html">Introduction</a></li>
            <li><a class="" href="../admin-guide/iscsi.html">iSCSI</a></li>
            <li><a class="" href="../admin-guide/keystore-quickstart.html">Keystore Quickstart</a></li>
            <li><a class="" href="../admin-guide/linux-kernel-tuning.html">Linux Kernel Tuning</a></li>
            <li><a class="" href="../admin-guide/logging.html">Logging</a></li>
            <li><a class="" href="../admin-guide/managing-snapshots.html">Managing snapshots</a></li>
            <li><a class="" href="../admin-guide/managing-volumes.html">Managing Volumes</a></li>
            <li><a class="" href="../admin-guide/mandatory-locks.html">Mandatory Locks</a></li>
            <li><a class="" href="../admin-guide/monitoring-workload.html">Monitoring Workload</a></li>
            <li><a class="" href="../admin-guide/network-configuration-techniques.html">Network Configuration Techniques</a></li>
            <li><a class="" href="../admin-guide/nfs-ganesha-integration.html">NFS-Ganesha Integration</a></li>
            <li><a class="" href="../admin-guide/object-storage.html">Object storage</a></li>
            <li><a class="" href="../admin-guide/performance-testing.html">Performance Testing</a></li>
            <li><a class="" href="../admin-guide/Puppet.html">Puppet</a></li>
            <li><a class="" href="../admin-guide/rdma-transport.html">RDMA Transport</a></li>
            <li><a class="" href="../admin-guide/resolving-peer-rejected.html">Resolving Peer Rejected</a></li>
            <li><a class="" href="../admin-guide/setting-up-clients.html">Setting up Clients</a></li>
            <li><a class="" href="../admin-guide/setting-up-volumes.html">Setting up volumes</a></li>
            <li><a class="" href="../admin-guide/ssl.html">SSL</a></li>
            <li><a class="" href="../admin-guide/start-stop-daemon.html">Start Stop Daemon</a></li>
            <li><a class="" href="../admin-guide/storage-pools.html">Storage Pools</a></li>
            <li><a class="" href="../admin-guide/trash.html">Trash</a></li>
            <li><a class="" href="../admin-guide/troubleshooting.html">Troubleshooting</a></li>
      </ul>
    </li>
</ul>
      </div>
      <div class="col-xs-12 col-sm-9 col-md-9 main">
        <div class="page-header">
          <h2>Gluster On ZFS</h2>
        </div>
        <div class="sect2">
<h3 id="gluster-on-zfs"><a class="anchor" href="#gluster-on-zfs"></a>Gluster On ZFS</h3>
<div class="paragraph">
<p>This is a step-by-step set of instructions to install Gluster on top of
ZFS as the backing file store. There are some commands which were
specific to my installation, specifically, the ZFS tuning section.
<em>Moniti estis.</em></p>
</div>
</div>
<div class="sect2">
<h3 id="preparation"><a class="anchor" href="#preparation"></a>Preparation</h3>
<div class="ulist">
<ul>
<li>
<p>Install CentOS 6.3</p>
</li>
<li>
<p>Assumption is that your hostname is <code>gfs01</code></p>
</li>
<li>
<p>Run all commands as the root user</p>
</li>
<li>
<p>yum update</p>
</li>
<li>
<p>Disable IP Tables</p>
<div class="paragraph">
<p><code>chkconfig iptables off</code> <code>service iptables stop</code></p>
</div>
</li>
<li>
<p>Disable SELinux</p>
<div class="ulist">
<ul>
<li>
<p>edit /etc/selinux/config</p>
</li>
<li>
<p>set SELINUX=disabled</p>
</li>
<li>
<p>reboot</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="install-zfs-on-linux"><a class="anchor" href="#install-zfs-on-linux"></a>Install ZFS on Linux</h3>
<div class="ulist">
<ul>
<li>
<p>For RHEL6 or 7 and derivatives, you can install the ZFSoL repo (and
EPEL) and use that to install ZFS</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">RHEL 6:
$ sudo yum localinstall --nogpgcheck `[`https://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm`](https://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm)
$ sudo yum localinstall --nogpgcheck `[`http://archive.zfsonlinux.org/epel/zfs-release.el6.noarch.rpm`](http://archive.zfsonlinux.org/epel/zfs-release.el6.noarch.rpm)
$ sudo yum install kernel-devel zfs

RHEL 7:
$ sudo yum localinstall --nogpgcheck `[`https://download.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-2.noarch.rpm`](https://download.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-2.noarch.rpm)
$ sudo yum localinstall --nogpgcheck `[`http://archive.zfsonlinux.org/epel/zfs-release.el7.noarch.rpm`](http://archive.zfsonlinux.org/epel/zfs-release.el7.noarch.rpm)
$ sudo yum install kernel-devel zfs</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>and skip to Finish ZFS Configuration below.</p>
</div>
<div class="paragraph">
<p>Or you can roll your own if you want specific patches:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>`yum groupinstall "Development Tools"`</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Download &amp; unpack latest SPL and ZFS tarballs from
<a href="http://www.zfsonlinux.org">zfsonlinux.org</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="install-dkms"><a class="anchor" href="#install-dkms"></a>Install DKMS</h4>
<div class="paragraph">
<p>We want automatically rebuild the kernel modules when we upgrade the
kernel, so you definitely want DKMS with ZFS on Linux.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Download latest RPM from <a href="http://linux.dell.com/dkms" class="bare">http://linux.dell.com/dkms</a></p>
</li>
<li>
<p>Install DKMS rpm -Uvh dkms*.rpm</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="build-install-spl"><a class="anchor" href="#build-install-spl"></a>Build &amp; Install SPL</h4>
<div class="ulist">
<ul>
<li>
<p>Enter SPL source directory</p>
</li>
<li>
<p>The following commands create two source &amp; three binary RPMs. Remove
the static module RPM (we are using DKMS) and install the rest:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./configure
make rpm
rm spl-modules-0.6.0*.x86_64.rpm
rpm -Uvh spl*.x86_64.rpm spl*.noarch.rpm</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="build-install-zfs"><a class="anchor" href="#build-install-zfs"></a>Build &amp; Install ZFS</h4>
<div class="ulist">
<ul>
<li>
<p><em>If you plan to use the 'xattr=sa' filesystem option, make sure you
have the ZFS fix for <a href="https://github.com/zfsonlinux/zfs/issues/1648" class="bare">https://github.com/zfsonlinux/zfs/issues/1648</a> *so
your symlinks don&#8217;t get corrupted.*</em> (applies to ZFSoL before 0.6.3,
xattr=sa is safe to use on 0.6.3 and later)</p>
</li>
<li>
<p>Enter ZFS source directory</p>
</li>
<li>
<p>The following commands create two source &amp; five binary RPMs. Remove
the static module RPM and install the rest. Note we have a few
preliminary packages to install before we can compile.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">yum install zlib-devel libuuid-devel libblkid-devel libselinux-devel parted lsscsi
./configure
make rpm
rm zfs-modules-0.6.0*.x86_64.rpm
rpm -Uvh zfs*.x86_64.rpm zfs*.noarch.rpm</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="finish-zfs-configuration"><a class="anchor" href="#finish-zfs-configuration"></a>Finish ZFS Configuration</h4>
<div class="ulist">
<ul>
<li>
<p>Reboot to allow all changes to take effect, if desired</p>
</li>
<li>
<p>Create ZFS storage pool. This is a simple example of 4 HDDs in RAID10.
NOTE: Check the latest <a href="http://zfsonlinux.org/faq.html">ZFS on Linux FAQ</a>
about configuring the /etc/zfs/zdev.conf file. You want to create
mirrored devices across controllers to maximize performance. Make sure
to run <code>udevadm trigger</code> after creating zdev.conf.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">zpool create -f sp1 mirror A0 B0 mirror A1 B1
zpool status sp1
df -h</code></pre>
</div>
</div>
</li>
<li>
<p>You should see the /sp1 mount point</p>
</li>
<li>
<p>Enable ZFS compression to save disk space:</p>
<div class="paragraph">
<p><code>zfs set compression=on sp1</code></p>
</div>
</li>
<li>
<p>you can also use lz4 compression on later versions of ZFS as it can be
faster, especially for incompressible workloads. It is safe to change
this on the fly, as ZFS will compress new data with the current setting:</p>
<div class="paragraph">
<p><code>zfs set compression=lz4 sp1</code></p>
</div>
</li>
<li>
<p>Set ZFS tunables. This is specific to my environment.</p>
<div class="ulist">
<ul>
<li>
<p>Set ARC cache min to 33% and max to 75% of installed RAM. Since this
is a dedicated storage node, I can get away with this. In my case my
servers have 24G of RAM. More RAM is better with ZFS.</p>
</li>
<li>
<p>We use SATA drives which do not accept command tagged queuing,
therefore set the min and max pending requests to 1</p>
</li>
<li>
<p>Disable read prefetch because it is almost completely useless and
does nothing in our environment but work the drives unnecessarily. I see
&lt;10% prefetch cache hits, so it&#8217;s really not required and actually hurts
performance.</p>
</li>
<li>
<p>Set transaction group timeout to 5 seconds to prevent the volume from
appearing to freeze due to a large batch of writes. 5 seconds is the
default, but safe to force this.</p>
</li>
<li>
<p>Ignore client flush/sync commands; let ZFS handle this with the
transaction group timeout flush. NOTE: Requires a UPS backup solution
unless you don&#8217;t mind losing that 5 seconds worth of data.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">echo &quot;options zfs zfs_arc_min=8G zfs_arc_max=18G zfs_vdev_min_pending=1 zfs_vdev_max_pending=1 zfs_prefetch_disable=1 zfs_txg_timeout=5&quot; &gt; /etc/modprobe.d/zfs.conf
reboot</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Setting the acltype property to posixacl indicates Posix ACLs should
be used.</p>
<div class="paragraph">
<p><code>zfs set acltype=posixacl sp1</code></p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="install-glusterfs"><a class="anchor" href="#install-glusterfs"></a>Install GlusterFS</h3>
<div class="literalblock">
<div class="content">
<pre>```sh
wget -P /etc/yum.repos.d `[`http://download.gluster.org/pub/gluster/glusterfs/LATEST/EPEL.repo/glusterfs-epel.repo`](http://download.gluster.org/pub/gluster/glusterfs/LATEST/EPEL.repo/glusterfs-epel.repo)
yum install glusterfs{-fuse,-server}
service glusterd start
service glusterd status
chkconfig glusterd on
```</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Continue with your GFS peer probe, volume creation, &amp;c.</p>
</li>
<li>
<p>To mount GFS volumes automatically after reboot, add these lines to
/etc/rc.local (assuming your gluster volume is called "export" and your
desired mount point is /export:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"># Mount GFS Volumes
mount -t glusterfs gfs01:/export /export</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="miscellaneous-notes-todo"><a class="anchor" href="#miscellaneous-notes-todo"></a>Miscellaneous Notes &amp; TODO</h3>
<div class="sect3">
<h4 id="daily-e-mail-status-reports"><a class="anchor" href="#daily-e-mail-status-reports"></a>Daily e-mail status reports</h4>
<div class="paragraph">
<p>Python script source; put your desired e-mail address in the 'toAddr'
variable. Add a crontab entry to run this daily.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>```sh
#!/usr/bin/python
import datetime,socket,smtplib,subprocess
def doShellCmd(cmd):
  subproc=subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE,)
  cmdOutput=subproc.communicate()[0]
  return cmdOutput
hostname=socket.gethostname()
statusLine="Status of " + hostname + " at " + str(datetime.datetime.now())
zpoolList=doShellCmd('zpool list')
zpoolStatus=doShellCmd('zpool status')
zfsList=doShellCmd('zfs list')
report=(statusLine + "\n" +
   "-----------------------------------------------------------\n" +
   zfsList +
   "-----------------------------------------------------------\n" +
   zpoolList +
   "-----------------------------------------------------------\n" +
        zpoolStatus)
fromAddr="From: root@" + hostname + "\r\n"
toAddr="To: user@your.com\r\n"
subject="Subject: ZFS Status from " + hostname + "\r\n"
msg = (subject + report)
server = smtplib.SMTP('localhost')
server.set_debuglevel(1)
server.sendmail(fromAddr, toAddr, msg)
server.quit()
```</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="restoring-files-from-zfs-snapshots"><a class="anchor" href="#restoring-files-from-zfs-snapshots"></a>Restoring files from ZFS Snapshots</h4>
<div class="paragraph">
<p>Show which node a file is on (for restoring files from ZFS snapshots):</p>
</div>
<div class="literalblock">
<div class="content">
<pre> `getfattr -n trusted.glusterfs.pathinfo &lt;file&gt;`</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="recurring-zfs-snapshots"><a class="anchor" href="#recurring-zfs-snapshots"></a>Recurring ZFS Snapshots</h4>
<div class="paragraph">
<p>Since the community site will not let me actually post the script due to
some random bug with Akismet spam blocking, I&#8217;ll just post links
instead.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://community.spiceworks.com/how_to/show/15303-recurring-zfs-snapshots">Recurring
ZFS Snapshots</a></p>
</li>
<li>
<p>Or use <a href="https://github.com/zfsonlinux/zfs-auto-snapshot" class="bare">https://github.com/zfsonlinux/zfs-auto-snapshot</a></p>
</li>
</ul>
</div>
</div>
</div>
      </div>
    </div>
  </div>
   <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
   <!-- Latest compiled and minified JavaScript -->
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
   <script type="text/javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      $("[id^='topicGroup']").on('show.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicGroup']").on('hide.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicSubGroup']").on('show.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
      $("[id^='topicSubGroup']").on('hide.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
    });
    /*]]>*/
  </script>
</body>
</html>