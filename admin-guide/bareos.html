<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Gluster User Documentation Latest | Gluster Docs Project | BareOS</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <link href="../../latest/_stylesheets/asciibinder.css" rel="stylesheet" />

   <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
   <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
   <!--[if lt IE 9]>
     <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
     <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
   <![endif]-->

  <link href="../../latest/_images/favicon32x32.png" rel="shortcut icon" type="text/css">
  <!--[if IE]><link rel="shortcut icon" href="../../latest/_images/favicon.ico"><![endif]-->
  <meta content="AsciiBinder" name="application-name">
</head>
<body>
  <div class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="http://www.asciibinder.org/"><img alt="AsciiBinder" src="../../latest/_images/asciibinder-logo-horizontal.png"></a>
      </div>
    </div>
  </div>
  <div class="container">
    <p class="toggle-nav visible-xs pull-left">
      <button class="btn btn-default btn-sm" type="button" data-toggle="offcanvas">Toggle nav</button>
    </p>
    <ol class="breadcrumb">
      <li class="sitename">
        <a href="../../index.html">Home</a>
      </li>
      <li class="hidden-xs active">
        <a href="../admin-guide/index.html">Gluster User Documentation Latest</a>
      </li>
      <li class="hidden-xs active">
        <a href="../admin-guide/index.html">Gluster Docs Project</a>
      </li>
      
      <li class="hidden-xs active">
        BareOS
      </li>
    </ol>
    <div class="row row-offcanvas row-offcanvas-left">
      <div class="col-xs-8 col-sm-3 col-md-3 sidebar sidebar-offcanvas">
        <ul class="nav nav-sidebar">
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup0">
        <span id="tgSpan0" class="fa fa-angle-down"></span>Gluster Docs Project
      </a>
      <ul id="topicGroup0" class="collapse in list-unstyled">
            <li><a class="" href="../admin-guide/index.html">Index</a></li>
            <li><a class="" href="../admin-guide/access-control-lists.html">Access Control Lists</a></li>
            <li><a class="" href="../admin-guide/accessing-gluster-from-windows.html">Accessing Gluster from Windows</a></li>
            <li><a class="" href="../admin-guide/arbiter-volumes-and-quorum.html">Arbiter-volumes and Quorum</a></li>
            <li><a class=" active" href="../admin-guide/bareos.html">BareOS</a></li>
            <li><a class="" href="../admin-guide/brick-naming-conventions.html">Brick naming conventions</a></li>
            <li><a class="" href="../admin-guide/building-qemu-with-gfapi-for-debian-based-systems.html">Building QEMU with gfapi for Debian-based systems</a></li>
            <li><a class="" href="../admin-guide/cinder.html">Cinder</a></li>
            <li><a class="" href="../admin-guide/Console.html">Console</a></li>
            <li><a class="" href="../admin-guide/compiling-rpms.html">Compiling RPMs</a></li>
            <li><a class="" href="../admin-guide/coreutils.html">Coreutils</a></li>
            <li><a class="" href="../admin-guide/did-you-know.html">Did you know</a></li>
            <li><a class="" href="../admin-guide/directory-quota.html">Diectory Quota</a></li>
            <li><a class="" href="../admin-guide/distributed-geo-replication.html">Distributed Geo Replication</a></li>
            <li><a class="" href="../admin-guide/export-and-netgroup-authentication.html">Export and netgroup authentication</a></li>
            <li><a class="" href="../admin-guide/filter.html">Filter</a></li>
            <li><a class="" href="../admin-guide/geo-replication.html">Geo Replication</a></li>
            <li><a class="" href="../admin-guide/glossary.html">Glossary</a></li>
            <li><a class="" href="../admin-guide/gluster-on-zfs.html">Gluster on ZFS</a></li>
            <li><a class="" href="../admin-guide/Hadoop.html">Hadoop</a></li>
            <li><a class="" href="../admin-guide/Handling-of-users-with-many-groups.html">Handling of users with many groups</a></li>
            <li><a class="" href="../admin-guide/introduction.html">Introduction</a></li>
            <li><a class="" href="../admin-guide/iscsi.html">iSCSI</a></li>
            <li><a class="" href="../admin-guide/keystore-quickstart.html">Keystore Quickstart</a></li>
            <li><a class="" href="../admin-guide/linux-kernel-tuning.html">Linux Kernel Tuning</a></li>
            <li><a class="" href="../admin-guide/logging.html">Logging</a></li>
            <li><a class="" href="../admin-guide/managing-snapshots.html">Managing snapshots</a></li>
            <li><a class="" href="../admin-guide/managing-volumes.html">Managing Volumes</a></li>
            <li><a class="" href="../admin-guide/mandatory-locks.html">Mandatory Locks</a></li>
            <li><a class="" href="../admin-guide/monitoring-workload.html">Monitoring Workload</a></li>
            <li><a class="" href="../admin-guide/network-configuration-techniques.html">Network Configuration Techniques</a></li>
            <li><a class="" href="../admin-guide/nfs-ganesha-integration.html">NFS-Ganesha Integration</a></li>
            <li><a class="" href="../admin-guide/object-storage.html">Object storage</a></li>
            <li><a class="" href="../admin-guide/performance-testing.html">Performance Testing</a></li>
            <li><a class="" href="../admin-guide/Puppet.html">Puppet</a></li>
            <li><a class="" href="../admin-guide/rdma-transport.html">RDMA Transport</a></li>
            <li><a class="" href="../admin-guide/resolving-peer-rejected.html">Resolving Peer Rejected</a></li>
            <li><a class="" href="../admin-guide/setting-up-clients.html">Setting up Clients</a></li>
            <li><a class="" href="../admin-guide/setting-up-volumes.html">Setting up volumes</a></li>
            <li><a class="" href="../admin-guide/ssl.html">SSL</a></li>
            <li><a class="" href="../admin-guide/start-stop-daemon.html">Start Stop Daemon</a></li>
            <li><a class="" href="../admin-guide/storage-pools.html">Storage Pools</a></li>
            <li><a class="" href="../admin-guide/trash.html">Trash</a></li>
            <li><a class="" href="../admin-guide/troubleshooting.html">Troubleshooting</a></li>
      </ul>
    </li>
</ul>
      </div>
      <div class="col-xs-12 col-sm-9 col-md-9 main">
        <div class="page-header">
          <h2>Configuring Bareos to store backups on Gluster</h2>
        </div>
        <div class="sect1">
<h2 id="configuring-bareos-to-store-backups-on-gluster"><a class="anchor" href="#configuring-bareos-to-store-backups-on-gluster"></a>Configuring Bareos to store backups on Gluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This description assumes that you already have a Gluster environment
ready and configured. The examples use <code>storage.example.org</code> as a Round
Robin DNS name that can be used to contact any of the available GlusterD
processes. The Gluster Volume that is used, is called <code>backups</code>. Client
systems would be able to access the volume by mounting it with FUSE like
this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># mount -t glusterfs storage.example.org:/backups /mnt</pre>
</div>
</div>
<div class="paragraph">
<p><a href="http://bareos.org">Bareos</a> contains a plugin for the Storage Daemon that
uses <code>libgfapi</code>. This makes it possible for Bareos to access the Gluster
Volumes without the need to have a FUSE mount available.</p>
</div>
<div class="paragraph">
<p>Here we will use one server that is dedicated for doing backups. This
system is called <code>backup.example.org</code>. The Bareos Director is running on
this host, together with the Bareos Storage Daemon. In the example,
there is a File Daemon running on the same server. This makes it
possible to backup the Bareos Director, which is useful as a backup of
the Bareos database and configuration is kept that way.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bareos-installation"><a class="anchor" href="#bareos-installation"></a>Bareos Installation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An absolute minimal Bareos installation needs a Bareos Director and a
Storage Daemon. In order to backup a filesystem, a File Daemon needs to
be available too. For the description in this document, CentOS-7 was
used, with the following packages and versions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://download.gluster.org">glusterfs-3.7.4</a></p>
</li>
<li>
<p><a href="http://download.bareos.org">bareos-14.2</a> with bareos-storage-glusterfs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Gluster Storage Servers do not need to have any Bareos packages
installed. It is often better to keep applications (Bareos) and storage
servers on different systems. So, when the Bareos repository has been
configured, install the packages on the <code>backup.example.org</code> server:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># yum install bareos-director bareos-database-sqlite3 \
              bareos-storage-glusterfs bareos-filedaemon \
              bareos-bconsole</pre>
</div>
</div>
<div class="paragraph">
<p>To keep things as simple as possible, SQlite it used. For production
deployments either MySQL or PostgrSQL is advised. It is needed to create
the initial database:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># sqlite3 /var/lib/bareos/bareos.db &lt; /usr/lib/bareos/scripts/ddl/creates/sqlite3.sql
# chown bareos:bareos /var/lib/bareos/bareos.db
# chmod 0660 /var/lib/bareos/bareos.db</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>bareos-bconsole</code> package is optional. <code>bconsole</code> is a terminal
application that can be used to initiate backups, check the status of
different Bareos components and the like. Testing the configuration with
<code>bconsole</code> is relatively simple.</p>
</div>
<div class="paragraph">
<p>Once the packages are installed, you will need to start and enable the
daemons:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># systemctl start bareos­sd
# systemctl start bareos­fd
# systemctl start bareos­dir
# systemctl enable bareos­sd
# systemctl enable bareos­fd
# systemctl enable bareos­dir</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="gluster-volume-preparation"><a class="anchor" href="#gluster-volume-preparation"></a>Gluster Volume preparation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are a few steps needed to allow Bareos to access the Gluster
Volume. By default Gluster does not allow clients to connect from an
unprivileged port. Because the Bareos Storage Daemon does not run as
root, permissions to connect need to be opened up.</p>
</div>
<div class="paragraph">
<p>There are two processes involved when a client accesses a Gluster
Volume. For the initial phase, GlusterD is contacted, when the client
received the layout of the volume, the client will connect to the bricks
directly. The changes to allow unprivileged processes to connect, are
therefore twofold:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In <code>/etc/glusterfs/glusterd.vol</code> the option
<code>rpc-auth-allow-insecure on</code> needs to be added on all storage servers.
After the modification of the configuration file, the GlusterD process
needs to be restarted with <code>systemctl restart glusterd</code>.</p>
</li>
<li>
<p>The brick processes for the volume are configured through a volume
option. By executing
<code>gluster volume set backups server.allow-insecure on</code> the needed option
gets set. Some versions of Gluster require a volume stop/start before
the option is taken into account, for these versions you will need to
execute <code>gluster volume stop backups</code> and
<code>gluster volume start backups</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Except for the network permissions, the Bareos Storage Daemon needs to
be allowed to write to the filesystem provided by the Gluster Volume.
This is achieved by setting normal UNIX permissions/ownership so that
the right user/group can write to the volume:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># mount -t glusterfs storage.example.org:/backups /mnt
# mkdir /mnt/bareos
# chown bareos:bareos /mnt/bareos
# chmod ug=rwx /mnt/bareos
# umount /mnt</pre>
</div>
</div>
<div class="paragraph">
<p>Depending on how users/groups are maintained in the environment, the
<code>bareos</code> user and group may not be available on the storage servers. If
that is the case, the <code>chown</code> command above can be adapted to use the
<code>uid</code> and <code>gid</code> of the <code>bareos</code> user and group from
<code>backup.example.org</code>. On the Bareos server, the output would look
similar to:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># id bareos
uid=998(bareos) gid=997(bareos) groups=997(bareos),6(disk),30(tape)</pre>
</div>
</div>
<div class="paragraph">
<p>And that makes the <code>chown</code> command look like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># chown 998:997 /mnt/bareos</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bareos-configuration"><a class="anchor" href="#bareos-configuration"></a>Bareos Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When <code>bareos-storage-glusterfs</code> got installed, an example configuration
file has been added too. The
<code>/etc/bareos/bareos-sd.d/device-gluster.conf</code> contains the
<code>Archive Device</code> directive, which is a URL for the Gluster Volume and
path where the backups should get stored. In our example, the entry
should get set to:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Device {
  Name = GlusterStorage
  Archive Device = gluster://storage.example.org/backups/bareos
  Device Type = gfapi
  Media Type = GlusterFile
  ...
}</pre>
</div>
</div>
<div class="paragraph">
<p>The default configuration of the Bareos provided jobs is to write
backups to <code>/var/lib/bareos/storage</code>. In order to write all the backups
to the Gluster Volume instead, the configuration for the Bareos Director
needs to be modified. In the <code>/etc/bareos/bareos-dir.conf</code>
configuration, the defaults for all jobs can be changed to use the
<code>GlusterFile</code> storage:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>JobDefs {
  Name = "DefaultJob"
  ...
#  Storage = File
  Storage = GlusterFile
  ...
}</pre>
</div>
</div>
<div class="paragraph">
<p>After changing the configuration files, the Bareos daemons need to apply
them. The easiest to inform the processes of the changed configuration
files is by instructing them to <code>reload</code> their configuration:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># bconsole
Connecting to Director backup:9101
1000 OK: backup-dir Version: 14.2.2 (12 December 2014)
Enter a period to cancel a command.
*reload</pre>
</div>
</div>
<div class="paragraph">
<p>With <code>bconsole</code> it is also possible to check if the configuration has
been applied. The <code>status</code> command can be used to show the URL of the
storage that is configured. When all is setup correctly, the result
looks like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>*status storage=GlusterFile
Connecting to Storage daemon GlusterFile at backup:9103
...
Device "GlusterStorage" (gluster://storage.example.org/backups/bareos) is not open.
...</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-your-first-backup"><a class="anchor" href="#create-your-first-backup"></a>Create your first backup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are several default jobs configured in the Bareos Director. One of
them is the <code>DefaultJob</code> which was modified in an earlier step. This job
uses the <code>SelfTest</code> FileSet, which backups <code>/usr/sbin</code>. Running this job
will verify if the configuration is working correctly. Additional jobs,
other FileSets and more File Daemons (clients that get backed up) can be
added later.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>*run
A job name must be specified.
The defined Job resources are:
     1: BackupClient1
     2: BackupCatalog
     3: RestoreFiles
Select Job resource (1-3): 1
Run Backup job
JobName:  BackupClient1
Level:    Incremental
Client:   backup-fd
...
OK to run? (yes/mod/no): yes
Job queued. JobId=1</pre>
</div>
</div>
<div class="paragraph">
<p>The job will need a few seconds to complete, the <code>status</code> command can be
used to show the progress. Once done, the <code>messages</code> command will
display the result:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>*messages
...
  JobId:                  1
  Job:                    BackupClient1.2015-09-30_21.17.56_12
  ...
  Termination:            Backup OK</pre>
</div>
</div>
<div class="paragraph">
<p>The archive that contains the backup will be located on the Gluster
Volume. To check if the file is available, mount the volume on a storage
server:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># mount -t glusterfs storage.example.org:/backups /mnt
# ls /mnt/bareos</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="further-reading"><a class="anchor" href="#further-reading"></a>Further Reading</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This document intends to provide a quick start of configuring Bareos to
use Gluster as a storage backend. Bareos can be configured to create
backups of different clients (which run a File Daemon), run jobs at
scheduled time and intervals and much more. The excellent
<a href="http://doc.bareos.org">Bareos documentation</a> can be consulted to find out
how to create backups in a much more useful way than can get expressed
on this page.</p>
</div>
</div>
</div>
      </div>
    </div>
  </div>
   <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
   <!-- Latest compiled and minified JavaScript -->
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
   <script type="text/javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      $("[id^='topicGroup']").on('show.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicGroup']").on('hide.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicSubGroup']").on('show.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
      $("[id^='topicSubGroup']").on('hide.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
    });
    /*]]>*/
  </script>
</body>
</html>